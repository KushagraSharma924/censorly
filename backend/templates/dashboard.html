<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Profanity Filter - SaaS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-800">ðŸŽ¬ AI Profanity Filter</h1>
                    <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded">SaaS</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-info" class="text-gray-600">Welcome!</span>
                    <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Login Section (shown when not authenticated) -->
        <div id="login-section" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow">
            <h2 class="text-2xl font-bold mb-6 text-center">Login to Your Dashboard</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                    <input type="email" id="login-email" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="login-password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                    Login
                </button>
            </form>
            <div class="mt-4 text-center">
                <p class="text-sm text-gray-600">
                    Demo credentials: <strong>admin@example.com</strong> / <strong>admin123</strong>
                </p>
            </div>
        </div>

        <!-- Dashboard Content (shown when authenticated) -->
        <div id="dashboard-content" class="hidden">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-gray-700">Total Videos</h3>
                    <p id="total-videos" class="text-3xl font-bold text-blue-600">0</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-gray-700">Completed</h3>
                    <p id="completed-videos" class="text-3xl font-bold text-green-600">0</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-gray-700">Processing</h3>
                    <p id="processing-videos" class="text-3xl font-bold text-yellow-600">0</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-gray-700">Minutes Processed</h3>
                    <p id="minutes-processed" class="text-3xl font-bold text-purple-600">0</p>
                </div>
            </div>

            <!-- Upload Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Video Upload -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Upload Video</h2>
                    <form id="upload-form" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Video File</label>
                            <input type="file" id="video-file" accept="video/*" class="w-full px-3 py-2 border rounded-lg" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Censoring Mode</label>
                            <select id="censoring-mode" class="w-full px-3 py-2 border rounded-lg">
                                <option value="beep">Beep (Replace with beep sound)</option>
                                <option value="mute">Mute (Replace with silence)</option>
                                <option value="cut">Cut (Remove segments)</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Profanity Threshold</label>
                            <input type="range" id="threshold" min="0.1" max="1.0" step="0.1" value="0.8" class="w-full">
                            <span id="threshold-value" class="text-sm text-gray-600">0.8</span>
                        </div>
                        <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">
                            Upload & Process
                        </button>
                    </form>
                </div>

                <!-- Training Upload -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Train Custom Dataset</h2>
                    <form id="training-form" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">CSV Training File</label>
                            <input type="file" id="training-file" accept=".csv" class="w-full px-3 py-2 border rounded-lg" required>
                            <p class="text-xs text-gray-500 mt-1">CSV format: word,language,category,severity</p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Description (Optional)</label>
                            <input type="text" id="training-description" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., Custom Hindi profanity words">
                        </div>
                        <button type="submit" class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600">
                            Upload & Train
                        </button>
                    </form>
                </div>
            </div>

            <!-- Jobs Table -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b">
                    <h2 class="text-xl font-bold">Recent Jobs</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">File</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Progress</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="jobs-table" class="divide-y divide-gray-200">
                            <!-- Jobs will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="status-message" class="fixed bottom-4 right-4 hidden max-w-sm bg-white border rounded-lg shadow-lg p-4">
        <div class="flex items-center">
            <div id="status-icon" class="mr-3"></div>
            <div>
                <div id="status-title" class="font-medium"></div>
                <div id="status-text" class="text-sm text-gray-600"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:9001/api';
        let authToken = localStorage.getItem('auth_token');
        let refreshInterval;

        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const dashboardContent = document.getElementById('dashboard-content');
        const loginForm = document.getElementById('login-form');
        const uploadForm = document.getElementById('upload-form');
        const trainingForm = document.getElementById('training-form');
        const thresholdSlider = document.getElementById('threshold');
        const thresholdValue = document.getElementById('threshold-value');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                showDashboard();
            } else {
                showLogin();
            }

            // Threshold slider
            thresholdSlider.addEventListener('input', function() {
                thresholdValue.textContent = this.value;
            });

            // Forms
            loginForm.addEventListener('submit', handleLogin);
            uploadForm.addEventListener('submit', handleVideoUpload);
            trainingForm.addEventListener('submit', handleTrainingUpload);

            // Logout
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        });

        // Authentication
        function showLogin() {
            loginSection.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            if (refreshInterval) clearInterval(refreshInterval);
        }

        function showDashboard() {
            loginSection.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
            loadDashboardData();
            refreshInterval = setInterval(loadDashboardData, 10000); // Refresh every 10 seconds
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const response = await axios.post(`${API_BASE}/auth/login`, {
                    email: email,
                    password: password
                });

                authToken = response.data.access_token;
                localStorage.setItem('auth_token', authToken);
                showStatus('success', 'Login Successful', 'Welcome to your dashboard!');
                showDashboard();
            } catch (error) {
                showStatus('error', 'Login Failed', error.response?.data?.error || 'Invalid credentials');
            }
        }

        function handleLogout() {
            authToken = null;
            localStorage.removeItem('auth_token');
            showLogin();
            showStatus('info', 'Logged Out', 'You have been logged out successfully');
        }

        // Dashboard Data
        async function loadDashboardData() {
            if (!authToken) return;

            try {
                // Load stats
                const statsResponse = await axios.get(`${API_BASE}/stats`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                const stats = statsResponse.data;
                document.getElementById('user-info').textContent = `Welcome, ${stats.user.email}!`;
                document.getElementById('total-videos').textContent = stats.job_stats.total;
                document.getElementById('completed-videos').textContent = stats.job_stats.completed;
                document.getElementById('processing-videos').textContent = stats.job_stats.processing + stats.job_stats.pending;
                document.getElementById('minutes-processed').textContent = Math.round(stats.usage.total_minutes_processed);

                // Load jobs
                const jobsResponse = await axios.get(`${API_BASE}/jobs?per_page=10`, {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                displayJobs(jobsResponse.data.jobs);
            } catch (error) {
                if (error.response?.status === 401) {
                    handleLogout();
                }
            }
        }

        function displayJobs(jobs) {
            const tbody = document.getElementById('jobs-table');
            tbody.innerHTML = '';

            jobs.forEach(job => {
                const row = document.createElement('tr');
                const statusColor = getStatusColor(job.status);
                const createdAt = new Date(job.created_at).toLocaleDateString();

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${job.original_filename}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">${job.status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${job.progress}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${createdAt}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${job.status === 'completed' ? 
                            `<a href="${API_BASE}/download/${job.id}" class="text-blue-600 hover:text-blue-800">Download</a>` :
                            `<span class="text-gray-400">Processing...</span>`
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusColor(status) {
            switch (status) {
                case 'completed': return 'bg-green-100 text-green-800';
                case 'processing': return 'bg-yellow-100 text-yellow-800';
                case 'pending': return 'bg-blue-100 text-blue-800';
                case 'failed': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // File Uploads
        async function handleVideoUpload(e) {
            e.preventDefault();
            const fileInput = document.getElementById('video-file');
            const file = fileInput.files[0];

            if (!file) {
                showStatus('error', 'No File', 'Please select a video file');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('censoring_mode', document.getElementById('censoring-mode').value);
            formData.append('profanity_threshold', document.getElementById('threshold').value);

            try {
                showStatus('info', 'Uploading...', 'Your video is being uploaded and will be processed shortly');
                
                const response = await axios.post(`${API_BASE}/upload`, formData, {
                    headers: { 
                        Authorization: `Bearer ${authToken}`,
                        'Content-Type': 'multipart/form-data'
                    }
                });

                showStatus('success', 'Upload Successful', `Job ${response.data.job_id} started. Processing will begin shortly.`);
                uploadForm.reset();
                loadDashboardData();
            } catch (error) {
                showStatus('error', 'Upload Failed', error.response?.data?.error || 'Failed to upload video');
            }
        }

        async function handleTrainingUpload(e) {
            e.preventDefault();
            const fileInput = document.getElementById('training-file');
            const file = fileInput.files[0];

            if (!file) {
                showStatus('error', 'No File', 'Please select a CSV file');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('description', document.getElementById('training-description').value);

            try {
                showStatus('info', 'Uploading...', 'Your training data is being uploaded');
                
                const response = await axios.post(`${API_BASE}/train`, formData, {
                    headers: { 
                        Authorization: `Bearer ${authToken}`,
                        'Content-Type': 'multipart/form-data'
                    }
                });

                showStatus('success', 'Training Started', `Training session ${response.data.training_session_id} started.`);
                trainingForm.reset();
            } catch (error) {
                showStatus('error', 'Training Failed', error.response?.data?.error || 'Failed to upload training data');
            }
        }

        // Status Messages
        function showStatus(type, title, message) {
            const statusDiv = document.getElementById('status-message');
            const iconDiv = document.getElementById('status-icon');
            const titleDiv = document.getElementById('status-title');
            const textDiv = document.getElementById('status-text');

            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸',
                warning: 'âš ï¸'
            };

            iconDiv.textContent = icons[type] || icons.info;
            titleDiv.textContent = title;
            textDiv.textContent = message;

            statusDiv.classList.remove('hidden');

            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
